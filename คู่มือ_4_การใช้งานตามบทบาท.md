# 📘 คู่มือโครงสร้างแอป EMS WeCare
## ส่วนที่ 4: การใช้งานตามบทบาท

**โครงการ:** EMS WeCare (Emergency Medical Services - We Care)  
**วันที่จัดทำ:** 29 มกราคม 2569  
**เวอร์ชัน:** 4.0

---

## 📋 สารบัญ

1. [ภาพรวมบทบาทผู้ใช้](#ภาพรวมบทบาทผู้ใช้)
2. [DEVELOPER - นักพัฒนา](#developer-นักพัฒนา)
3. [ADMIN - ผู้ดูแลระบบ](#admin-ผู้ดูแลระบบ)
4. [OFFICER/RADIO - เจ้าหน้าที่/ศูนย์วิทยุ](#officerradio-เจ้าหน้าที่ศูนย์วิทยุ)
5. [DRIVER - คนขับรถพยาบาล](#driver-คนขับรถพยาบาล)
6. [COMMUNITY - ประชาชน/อาสาสมัคร](#community-ประชาชนอาสาสมัคร)
7. [EXECUTIVE - ผู้บริหาร](#executive-ผู้บริหาร)
8. [Data Flow Examples](#data-flow-examples)

---

## 👥 ภาพรวมบทบาทผู้ใช้

### สรุปบทบาททั้งหมด (6 Roles)

| บทบาท | ระดับสิทธิ์ | จำนวนหน้า | ฟีเจอร์หลัก |
|--------|------------|-----------|-------------|
| **DEVELOPER** | Full Access | 1 | System monitoring, Debug tools |
| **ADMIN** | Administrative | 4 | User management, Audit logs, Settings |
| **OFFICER/RADIO** | Operational | 8 | Patient/Ride/Driver management |
| **DRIVER** | Driver-specific | 3 | Job management, Location tracking |
| **COMMUNITY** | Community-specific | 6 | Register patient, Request ride |
| **EXECUTIVE** | Read-only Analytics | 1 | Reports, Statistics |

### Role Hierarchy

```
DEVELOPER (สูงสุด)
    ↓
ADMIN
    ↓
OFFICER / RADIO CENTER
    ↓
DRIVER / COMMUNITY / EXECUTIVE
```

---

## 🔧 DEVELOPER - นักพัฒนา

### สิทธิ์การเข้าถึง
- ✅ **Full System Access** - เข้าถึงทุกฟีเจอร์
- ✅ เห็นข้อมูลทั้งหมดในระบบ
- ✅ จัดการฐานข้อมูลโดยตรง
- ✅ ดู System Logs และ Debug Information

### หน้าจอหลัก

#### 1. DeveloperDashboardPage.tsx

**ฟีเจอร์:**
```typescript
// 1. System Overview
- Server Status (Online/Offline)
- Database Status
- API Response Time
- Memory Usage
- CPU Usage

// 2. Database Management
- View all tables
- Execute SQL queries
- Database backup/restore
- View table schemas

// 3. API Testing
- Test all API endpoints
- View request/response
- Monitor API performance

// 4. Log Viewer
- System logs
- Error logs
- Access logs
- Real-time log streaming

// 5. Debug Tools
- Clear cache
- Reset database
- Generate test data
- Run migrations
```

### Use Cases

#### UC-DEV-01: ดู System Logs
```
1. เข้าสู่ Developer Dashboard
2. คลิก "System Logs"
3. เลือกประเภท log (System/Error/Access)
4. กรอง log ตามวันที่/ระดับ
5. ดูรายละเอียด log
6. Export logs (ถ้าต้องการ)
```

#### UC-DEV-02: ทดสอบ API
```
1. เข้าสู่ Developer Dashboard
2. คลิก "API Testing"
3. เลือก endpoint ที่ต้องการทดสอบ
4. กรอก parameters/body
5. คลิก "Send Request"
6. ดู Response และ Status Code
```

#### UC-DEV-03: จัดการฐานข้อมูล
```
1. เข้าสู่ Developer Dashboard
2. คลิก "Database Management"
3. เลือกตารางที่ต้องการดู
4. ดูข้อมูลในตาราง
5. Execute SQL query (ถ้าต้องการ)
6. Backup database
```

---

## 👨‍💼 ADMIN - ผู้ดูแลระบบ

### สิทธิ์การเข้าถึง
- ✅ จัดการผู้ใช้งานทั้งหมด (CRUD)
- ✅ ดู Audit Logs
- ✅ ตั้งค่าระบบ
- ✅ จัดการข่าวสาร
- ✅ จัดการประเภทรถพยาบาล

### หน้าจอหลัก

#### 1. AdminDashboardPage.tsx

**ฟีเจอร์:**
```typescript
// Dashboard Overview
- จำนวนผู้ใช้ทั้งหมด (แยกตาม Role)
- จำนวนผู้ป่วย
- จำนวนการเดินทาง
- จำนวนคนขับ
- กิจกรรมล่าสุด
- Audit Logs ล่าสุด
```

#### 2. AdminUserManagementPage.tsx

**ฟีเจอร์:**
```typescript
// User Management
1. รายการผู้ใช้ทั้งหมด (Table with Pagination)
   - กรองตาม Role
   - ค้นหาตามชื่อ/อีเมล
   - กรองตามสถานะ (Active/Inactive)

2. สร้างผู้ใช้ใหม่
   - กรอกข้อมูล (Email, Password, Role, Full Name)
   - Validate ข้อมูล
   - บันทึก

3. แก้ไขผู้ใช้
   - แก้ไขข้อมูลส่วนตัว
   - เปลี่ยน Role
   - Reset รหัสผ่าน
   - เปลี่ยนสถานะ (Active/Inactive)

4. ลบผู้ใช้
   - ยืนยันการลบ
   - ลบข้อมูลที่เกี่ยวข้อง
```

**Components:**
- `AdminUserTable.tsx` - ตารางแสดงผู้ใช้
- `AdminUserForm.tsx` - ฟอร์มสร้าง/แก้ไขผู้ใช้
- `UserManagementFilters.tsx` - ฟิลเตอร์ค้นหา

#### 3. AdminAuditLogsPage.tsx

**ฟีเจอร์:**
```typescript
// Audit Logs
1. รายการ Audit Logs (Table with Pagination)
   - แสดง: User, Action, Resource, Timestamp
   - กรองตาม User
   - กรองตาม Action
   - กรองตามวันที่
   - ค้นหา

2. ดูรายละเอียด Log
   - User information
   - Action details
   - Resource affected
   - IP Address
   - User Agent
   - Hash (for integrity verification)

3. Verify Hash Chain
   - ตรวจสอบความถูกต้องของ Audit Logs
   - แสดงผลการตรวจสอบ

4. Export Logs
   - Export เป็น CSV
   - Export เป็น JSON
```

**Components:**
- `AuditLogTable.tsx` - ตารางแสดง Audit Logs

#### 4. AdminSystemSettingsPage.tsx

**ฟีเจอร์:**
```typescript
// System Settings
1. General Settings
   - System Name
   - System Logo
   - Contact Information

2. API Keys
   - Google Maps API Key
   - Gemini API Key

3. Email Settings
   - SMTP Server
   - Email Templates

4. Vehicle Types Management
   - เพิ่ม/แก้ไข/ลบประเภทรถ
   - กำหนด Icon
   - กำหนด Capacity
   - กำหนด Features

5. Backup & Restore
   - Backup Database
   - Restore Database
   - Schedule Auto Backup
```

**Components:**
- `SystemSettingsForm.tsx` - ฟอร์มตั้งค่าระบบ

### Use Cases

#### UC-ADMIN-01: สร้างผู้ใช้ใหม่
```
1. เข้าสู่ Admin Dashboard
2. คลิก "User Management"
3. คลิก "Create New User"
4. กรอกข้อมูล:
   - Email: newuser@example.com
   - Password: SecurePass123!
   - Role: community
   - Full Name: ชื่อผู้ใช้
5. คลิก "Create User"
6. ระบบแสดงข้อความสำเร็จ
7. ผู้ใช้ใหม่ปรากฏในรายการ
```

#### UC-ADMIN-02: ดู Audit Logs
```
1. เข้าสู่ Admin Dashboard
2. คลิก "Audit Logs"
3. เลือกกรอง:
   - User: admin@example.com
   - Action: CREATE_PATIENT
   - Date Range: วันนี้
4. คลิก "Apply Filters"
5. ดูรายการ Logs ที่กรอง
6. คลิกดูรายละเอียด Log
7. Export เป็น CSV (ถ้าต้องการ)
```

#### UC-ADMIN-03: ตั้งค่า Google Maps API Key
```
1. เข้าสู่ Admin Dashboard
2. คลิก "System Settings"
3. เลือกแท็บ "API Keys"
4. กรอก Google Maps API Key
5. คลิก "Test API Key" (ทดสอบ)
6. คลิก "Save Settings"
7. ระบบแสดงข้อความสำเร็จ
```

---

## 📞 OFFICER/RADIO - เจ้าหน้าที่/ศูนย์วิทยุ

### สิทธิ์การเข้าถึง
- ✅ จัดการผู้ป่วยทั้งหมด
- ✅ จัดการการเดินทางทั้งหมด
- ✅ จัดการคนขับ
- ✅ จ่ายงาน (Dispatch)
- ✅ ดูแผนที่ Real-time
- ✅ สร้างรายงาน

### หน้าจอหลัก

#### 1. OfficeDashboard.tsx / RadioDashboard.tsx

**ฟีเจอร์:**
```typescript
// Real-time Dashboard
1. สถิติ Overview
   - คำขอใหม่วันนี้
   - คำขอที่กำลังดำเนินการ
   - คนขับที่พร้อมให้บริการ
   - รถพยาบาลที่พร้อมใช้งาน

2. คำขอล่าสุด (Real-time)
   - แสดงคำขอใหม่ทันที (Socket.io)
   - สถานะ: PENDING
   - ปุ่ม "Assign Driver" (จ่ายงาน)

3. แผนที่ Overview
   - แสดงตำแหน่งคนขับทั้งหมด
   - แสดงคำขอที่รอดำเนินการ
   - Real-time updates

4. Quick Actions
   - สร้างคำขอใหม่
   - ลงทะเบียนผู้ป่วยใหม่
   - ดูรายงาน
```

#### 2. OfficeManagePatientsPage.tsx

**ฟีเจอร์:**
```typescript
// Patient Management
1. รายการผู้ป่วยทั้งหมด (Table with Pagination)
   - ค้นหาตามชื่อ/เลขบัตร
   - กรองตามหมู่บ้าน
   - กรองตามประเภทผู้ป่วย
   - เรียงลำดับ

2. ดูรายละเอียดผู้ป่วย
   - ข้อมูลส่วนตัว
   - ข้อมูลสุขภาพ
   - ประวัติการเดินทาง
   - ไฟล์แนบ

3. สร้างผู้ป่วยใหม่
   - Wizard 5 ขั้นตอน (เหมือน Community)

4. แก้ไขข้อมูลผู้ป่วย
   - แก้ไขข้อมูลทั้งหมด

5. ลบผู้ป่วย
   - ยืนยันการลบ
```

#### 3. OfficeManageRidesPage.tsx

**ฟีเจอร์:**
```typescript
// Ride Management
1. รายการการเดินทางทั้งหมด (Table with Pagination)
   - กรองตามสถานะ (PENDING, ASSIGNED, IN_PROGRESS, COMPLETED, CANCELLED)
   - กรองตามวันที่
   - ค้นหาตามชื่อผู้ป่วย/คนขับ
   - Real-time updates (Socket.io)

2. ดูรายละเอียดการเดินทาง
   - ข้อมูลผู้ป่วย
   - ข้อมูลคนขับ
   - เส้นทาง
   - Timeline events
   - แผนที่

3. สร้างคำขอใหม่
   - เลือกผู้ป่วย
   - กรอกปลายทาง
   - กำหนดเวลานัดหมาย
   - ระบุความต้องการพิเศษ

4. จ่ายงาน (Assign Driver)
   - เลือกคนขับที่ว่าง
   - ยืนยันการมอบหมาย
   - ส่งการแจ้งเตือนไปยังคนขับ (Socket.io)

5. อัปเดตสถานะ
   - เปลี่ยนสถานะการเดินทาง
   - บันทึก Timeline event

6. ยกเลิกการเดินทาง
   - ระบุเหตุผล
   - ยืนยันการยกเลิก
```

#### 4. OfficeManageDriversPage.tsx

**ฟีเจอร์:**
```typescript
// Driver Management
1. รายการคนขับทั้งหมด (Table)
   - กรองตามสถานะ (AVAILABLE, ON_DUTY, OFF_DUTY)
   - ค้นหาตามชื่อ
   - แสดงจำนวนงานวันนี้

2. ดูรายละเอียดคนขับ
   - ข้อมูลส่วนตัว
   - ใบขับขี่
   - รถที่ใช้งาน
   - สถิติการทำงาน
   - ประวัติการทำงาน

3. อัปเดตสถานะคนขับ
   - เปลี่ยนสถานะ (AVAILABLE/ON_DUTY/OFF_DUTY)

4. มอบหมายรถพยาบาล
   - เลือกรถพยาบาล
   - บันทึก
```

#### 5. MapCommandPage.tsx

**ฟีเจอร์:**
```typescript
// Map Command Center
1. แผนที่แบบเต็มหน้าจอ (Leaflet)
   - แสดงตำแหน่งคนขับทั้งหมด (Real-time)
   - แสดงคำขอที่รอดำเนินการ
   - แสดงการเดินทางที่กำลังดำเนินการ

2. Markers
   - คนขับ: สีเขียว (AVAILABLE), สีน้ำเงิน (ON_DUTY)
   - คำขอ: สีแดง (PENDING)
   - การเดินทาง: สีเหลือง (IN_PROGRESS)

3. Popup Information
   - คลิก Marker เพื่อดูรายละเอียด
   - ปุ่ม Quick Actions

4. Real-time Updates
   - อัปเดตตำแหน่งคนขับทุก 10 วินาที
   - แสดงคำขอใหม่ทันที
```

#### 6. OfficeReportsPage.tsx

**ฟีเจอร์:**
```typescript
// Reports
1. เลือกประเภทรายงาน
   - รายงานการเดินทาง
   - รายงานคนขับ
   - รายงานผู้ป่วย

2. กรองข้อมูล
   - วันที่เริ่มต้น - สิ้นสุด
   - สถานะ
   - คนขับ/ผู้ป่วย

3. แสดงผลรายงาน
   - ตาราง
   - กราฟ
   - สถิติ

4. Export รายงาน
   - PDF
   - Excel
   - CSV
```

### Use Cases

#### UC-OFFICER-01: จ่ายงานให้คนขับ
```
1. เข้าสู่ Officer Dashboard
2. เห็นคำขอใหม่ (Real-time notification)
3. คลิก "View Details" ที่คำขอ
4. ดูรายละเอียด:
   - ผู้ป่วย: นาย ก.
   - สถานที่รับ: บ้านเลขที่ 123
   - ปลายทาง: โรงพยาบาล
5. คลิก "Assign Driver"
6. เลือกคนขับที่ว่าง (แสดงเฉพาะ AVAILABLE)
7. ยืนยันการมอบหมาย
8. ระบบส่งการแจ้งเตือนไปยังคนขับ
9. สถานะเปลี่ยนเป็น "ASSIGNED"
```

#### UC-OFFICER-02: ติดตามการเดินทาง Real-time
```
1. เข้าสู่ Map Command Page
2. ดูแผนที่แบบเต็มหน้าจอ
3. เห็น Marker คนขับเคลื่อนที่ (Real-time)
4. คลิก Marker คนขับ
5. ดูรายละเอียด:
   - ชื่อคนขับ
   - สถานะ: ON_DUTY
   - งานปัจจุบัน: ส่งนาย ก. ไปโรงพยาบาล
   - ระยะทางที่เหลือ: 5 กม.
6. ติดตามจนกว่าจะถึงปลายทาง
```

#### UC-OFFICER-03: สร้างรายงานการเดินทาง
```
1. เข้าสู่ Office Reports Page
2. เลือกประเภทรายงาน: "รายงานการเดินทาง"
3. กรองข้อมูล:
   - วันที่: 1-31 ม.ค. 2569
   - สถานะ: COMPLETED
4. คลิก "Generate Report"
5. ดูรายงาน:
   - จำนวนการเดินทางทั้งหมด: 150
   - เฉลี่ยต่อวัน: 5
   - กราฟแสดงแนวโน้ม
6. คลิก "Export to PDF"
7. ดาวน์โหลดไฟล์ PDF
```

---

## 🚗 DRIVER - คนขับรถพยาบาล

### สิทธิ์การเข้าถึง
- ✅ ดูงานที่ได้รับมอบหมาย
- ✅ อัปเดตสถานะงาน
- ✅ ส่งตำแหน่ง GPS Real-time
- ✅ ดูรายละเอียดผู้ป่วย
- ✅ ดูประวัติการทำงาน
- ✅ แก้ไขโปรไฟล์

### หน้าจอหลัก

#### 1. DriverTodayJobsPage.tsx

**ฟีเจอร์:**
```typescript
// Today's Jobs
1. รายการงานวันนี้ (Cards)
   - งานที่ได้รับมอบหมาย (ASSIGNED)
   - งานที่กำลังทำ (IN_PROGRESS)
   - งานที่เสร็จสิ้น (COMPLETED)

2. Job Card แสดง:
   - ชื่อผู้ป่วย
   - สถานที่รับ
   - ปลายทาง
   - เวลานัดหมาย
   - ระยะทาง
   - ความต้องการพิเศษ

3. ดูรายละเอียดงาน
   - ข้อมูลผู้ป่วยแบบเต็ม
   - ข้อมูลสุขภาพ
   - แผนที่เส้นทาง
   - AI Route Optimization (Gemini)

4. อัปเดตสถานะงาน
   - รับงาน (ASSIGNED → IN_PROGRESS)
   - เริ่มเดินทาง
   - ถึงจุดรับ
   - ถึงปลายทาง
   - เสร็จสิ้น (IN_PROGRESS → COMPLETED)

5. GPS Location Tracking
   - ส่งตำแหน่งอัตโนมัติทุก 10 วินาที
   - แสดงตำแหน่งปัจจุบันบนแผนที่
```

**Components:**
- `DriverJobCard.tsx` - การ์ดแสดงงาน
- `DriverLocationTracker.tsx` - ติดตามตำแหน่ง GPS

#### 2. DriverHistoryPage.tsx

**ฟีเจอร์:**
```typescript
// Job History
1. รายการงานที่ผ่านมา (Table with Pagination)
   - กรองตามวันที่
   - กรองตามสถานะ
   - ค้นหา

2. ดูรายละเอียดงานที่ผ่านมา
   - ข้อมูลผู้ป่วย
   - เส้นทาง
   - เวลาที่ใช้
   - ระยะทาง

3. สถิติ
   - จำนวนงานทั้งหมด
   - จำนวนงานเดือนนี้
   - ระยะทางรวม
   - เวลาเฉลี่ยต่องาน
```

#### 3. DriverProfilePage.tsx

**ฟีเจอร์:**
```typescript
// Driver Profile
1. ข้อมูลส่วนตัว
   - ชื่อ-นามสกุล
   - เบอร์โทร
   - รูปโปรไฟล์

2. ข้อมูลใบขับขี่
   - เลขที่ใบขับขี่
   - วันหมดอายุ

3. รถที่ใช้งาน
   - ทะเบียนรถ
   - ประเภทรถ

4. สถิติการทำงาน
   - จำนวนงานทั้งหมด
   - จำนวนงานเดือนนี้
   - คะแนนเฉลี่ย (ถ้ามี)

5. แก้ไขโปรไฟล์
   - แก้ไขข้อมูลส่วนตัว
   - อัปโหลดรูปโปรไฟล์
   - เปลี่ยนรหัสผ่าน
```

### Use Cases

#### UC-DRIVER-01: รับงานและเริ่มเดินทาง
```
1. เข้าสู่ Driver Dashboard
2. เห็นงานใหม่ (Real-time notification)
3. คลิกดูรายละเอียดงาน:
   - ผู้ป่วย: นาย ก.
   - รับที่: บ้านเลขที่ 123
   - ส่งที่: โรงพยาบาล
   - เวลานัดหมาย: 14:00 น.
4. ดูแผนที่เส้นทาง
5. คลิก "AI Route Optimization" (Gemini แนะนำเส้นทาง)
6. คลิก "Accept Job"
7. สถานะเปลี่ยนเป็น "IN_PROGRESS"
8. ระบบเริ่มส่งตำแหน่ง GPS อัตโนมัติ
9. เดินทางไปรับผู้ป่วย
10. ถึงจุดรับ → คลิก "Arrived at Pickup"
11. รับผู้ป่วยขึ้นรถ
12. เดินทางไปปลายทาง
13. ถึงปลายทาง → คลิก "Arrived at Destination"
14. ส่งผู้ป่วย
15. คลิก "Complete Job"
16. สถานะเปลี่ยนเป็น "COMPLETED"
```

#### UC-DRIVER-02: ดูประวัติการทำงาน
```
1. เข้าสู่ Driver Dashboard
2. คลิก "Job History"
3. เลือกกรอง:
   - วันที่: เดือนนี้
   - สถานะ: COMPLETED
4. ดูรายการงานที่เสร็จสิ้น
5. คลิกดูรายละเอียดงาน
6. ดูสถิติ:
   - จำนวนงานเดือนนี้: 45
   - ระยะทางรวม: 500 กม.
   - เวลาเฉลี่ยต่องาน: 30 นาที
```

---

## 🏘️ COMMUNITY - ประชาชน/อาสาสมัคร

### สิทธิ์การเข้าถึง
- ✅ ลงทะเบียนผู้ป่วย
- ✅ เรียกรถพยาบาล
- ✅ ดูข้อมูลผู้ป่วยของตนเอง (Data Isolation)
- ✅ ดูสถานะการเดินทางของตนเอง
- ✅ แก้ไขโปรไฟล์

### หน้าจอหลัก

#### 1. CommunityDashboard.tsx

**ฟีเจอร์:**
```typescript
// Community Dashboard
1. สถิติส่วนตัว
   - จำนวนผู้ป่วยที่ลงทะเบียน
   - จำนวนคำขอทั้งหมด
   - คำขอที่กำลังดำเนินการ

2. Quick Actions
   - ลงทะเบียนผู้ป่วยใหม่
   - เรียกรถพยาบาล
   - ดูรายการผู้ป่วย
   - ดูสถานะการเดินทาง

3. การเดินทางล่าสุด
   - แสดง 5 รายการล่าสุด
   - สถานะ
   - ปุ่ม "View Details"

4. ข่าวสาร
   - ข่าวสารจากระบบ
```

#### 2. CommunityRegisterPatientPage.tsx

**Wizard 5 ขั้นตอน:**

```typescript
// Step 1: ข้อมูลพื้นฐาน
{
  full_name: "นาย ก. ข.",
  national_id: "1234567890123",
  dob: "1950-01-01",
  age: 74,
  gender: "ชาย",
  blood_type: "O",
  rh_factor: "+",
  health_coverage: "บัตรทอง"
}

// Step 2: ที่อยู่
{
  // ที่อยู่ตามบัตรประชาชน
  id_card_house_number: "123",
  id_card_village: "หมู่ 1",
  id_card_subdistrict: "ตำบลA",
  id_card_district: "อำเภอB",
  id_card_province: "จังหวัดC",
  id_card_postal_code: "12345",
  
  // ที่อยู่ปัจจุบัน (ใช้เดียวกับบัตร หรือ กรอกใหม่)
  current_house_number: "123",
  current_village: "หมู่ 1",
  // ...
  
  contact_phone: "0812345678"
}

// Step 3: ตำแหน่งบนแผนที่
{
  latitude: "13.7563",
  longitude: "100.5018",
  landmark: "ใกล้วัด"
}
// แสดงแผนที่ Leaflet
// คลิกเพื่อเลือกตำแหน่ง
// ระบุ Landmark

// Step 4: ข้อมูลสุขภาพ
{
  patient_types: ["ติดเตียง", "ผู้สูงอายุ"],
  chronic_diseases: ["เบาหวาน", "ความดันโลหิตสูง"],
  allergies: ["ยาปฏิชีวนะ"]
}
// Multi-select Autocomplete

// Step 5: อัปโหลดรูปภาพและเอกสาร
{
  profile_image: File,
  id_card_image: File,
  other_documents: [File, File]
}
// Drag & Drop หรือ คลิกเลือกไฟล์
```

**Validation:**
- ตรวจสอบเลขบัตรประชาชน 13 หลัก
- ตรวจสอบเบอร์โทร 10 หลัก
- ตรวจสอบวันเกิด (ต้องไม่เกินวันปัจจุบัน)
- ตรวจสอบไฟล์ (ขนาด, ประเภท)

#### 3. CommunityRequestRidePage.tsx

**ฟีเจอร์:**
```typescript
// Request Ride Form
1. เลือกผู้ป่วย (Dropdown)
   - แสดงเฉพาะผู้ป่วยที่ตนลงทะเบียน
   - Auto-populate ข้อมูลเมื่อเลือก

2. ข้อมูลผู้ป่วย (Auto-filled)
   - ชื่อ
   - เบอร์โทร
   - สถานที่รับ (จากข้อมูลผู้ป่วย)

3. ปลายทาง
   - กรอกที่อยู่ปลายทาง
   - เลือกตำแหน่งบนแผนที่

4. รายละเอียดการเดินทาง
   - เวลานัดหมาย (Date + Time Picker)
   - ประเภทการเดินทาง (emergency, scheduled, transfer)
   - ความต้องการพิเศษ (Multi-select)
     - เปลนอน
     - เก้าอี้รถเข็น
     - ออกซิเจน
     - อื่นๆ

5. หมายเหตุ
   - กรอกข้อมูลเพิ่มเติม (Optional)

6. ยืนยันและส่งคำขอ
   - ตรวจสอบข้อมูล
   - คลิก "Submit Request"
   - แสดงข้อความสำเร็จ
   - Redirect ไปยัง ManageRidesPage
```

#### 4. ManagePatientsPage.tsx

**ฟีเจอร์:**
```typescript
// Manage Patients (Data Isolation)
1. รายการผู้ป่วยของฉัน (Table with Pagination)
   - แสดงเฉพาะผู้ป่วยที่ตนลงทะเบียน
   - ค้นหาตามชื่อ
   - กรองตามประเภท
   - เรียงลำดับ

2. ดูรายละเอียดผู้ป่วย
   - ข้อมูลทั้งหมด
   - ประวัติการเดินทาง
   - ไฟล์แนบ

3. แก้ไขข้อมูลผู้ป่วย
   - แก้ไขข้อมูลทั้งหมด
   - อัปโหลดไฟล์เพิ่ม

4. ลบผู้ป่วย
   - ยืนยันการลบ
   - ลบข้อมูลที่เกี่ยวข้อง
```

#### 5. ManageRidesPage.tsx

**ฟีเจอร์:**
```typescript
// Manage Rides (Data Isolation)
1. รายการการเดินทางของฉัน (Table with Pagination)
   - แสดงเฉพาะการเดินทางที่ตนสร้าง
   - กรองตามสถานะ
   - กรองตามวันที่
   - Real-time updates (Socket.io)

2. ดูรายละเอียดการเดินทาง
   - ข้อมูลผู้ป่วย
   - ข้อมูลคนขับ (ถ้ามี)
   - สถานะปัจจุบัน
   - Timeline events
   - แผนที่ (ถ้ากำลังเดินทาง)

3. ติดตามสถานะ Real-time
   - PENDING: รอดำเนินการ
   - ASSIGNED: มอบหมายคนขับแล้ว (แสดงชื่อคนขับ)
   - IN_PROGRESS: กำลังเดินทาง (แสดงตำแหน่งบนแผนที่)
   - COMPLETED: เสร็จสิ้น
   - CANCELLED: ยกเลิก

4. ยกเลิกการเดินทาง
   - เฉพาะสถานะ PENDING หรือ ASSIGNED
   - ระบุเหตุผล
   - ยืนยันการยกเลิก
```

#### 6. PatientDetailPage.tsx

**ฟีเจอร์:**
```typescript
// Patient Details
1. ข้อมูลส่วนตัว
   - รูปโปรไฟล์
   - ชื่อ-นามสกุล
   - เลขบัตรประชาชน
   - วันเกิด / อายุ
   - เพศ
   - กลุ่มเลือด

2. ข้อมูลติดต่อ
   - เบอร์โทร
   - ที่อยู่ตามบัตร
   - ที่อยู่ปัจจุบัน

3. ตำแหน่งบนแผนที่
   - แสดงแผนที่ Leaflet
   - Marker ตำแหน่งบ้าน
   - Landmark

4. ข้อมูลสุขภาพ
   - ประเภทผู้ป่วย
   - โรคประจำตัว
   - ประวัติแพ้ยา

5. ไฟล์แนบ
   - รูปโปรไฟล์
   - สำเนาบัตรประชาชน
   - เอกสารอื่นๆ
   - ดาวน์โหลดไฟล์

6. ประวัติการเดินทาง
   - รายการการเดินทางทั้งหมด
   - สถานะ
   - วันที่

7. ปุ่ม Actions
   - แก้ไขข้อมูล
   - เรียกรถพยาบาล
   - ลบผู้ป่วย
```

### Use Cases

#### UC-COMMUNITY-01: ลงทะเบียนผู้ป่วยใหม่
```
1. เข้าสู่ Community Dashboard
2. คลิก "Register New Patient"
3. Wizard Step 1: กรอกข้อมูลพื้นฐาน
   - ชื่อ: นาย ก. ข.
   - เลขบัตร: 1234567890123
   - วันเกิด: 1/1/1950
   - เพศ: ชาย
   - กลุ่มเลือด: O+
4. คลิก "Next"
5. Wizard Step 2: กรอกที่อยู่
   - ที่อยู่ตามบัตร: ...
   - ที่อยู่ปัจจุบัน: ใช้เดียวกับบัตร
   - เบอร์โทร: 0812345678
6. คลิก "Next"
7. Wizard Step 3: เลือกตำแหน่งบนแผนที่
   - คลิกบนแผนที่
   - ระบุ Landmark: ใกล้วัด
8. คลิก "Next"
9. Wizard Step 4: กรอกข้อมูลสุขภาพ
   - ประเภท: ติดเตียง, ผู้สูงอายุ
   - โรคประจำตัว: เบาหวาน
   - แพ้ยา: ยาปฏิชีวนะ
10. คลิก "Next"
11. Wizard Step 5: อัปโหลดรูปภาพ
    - รูปโปรไฟล์: เลือกไฟล์
    - สำเนาบัตร: เลือกไฟล์
12. คลิก "Complete Registration"
13. ระบบแสดงข้อความสำเร็จ
14. Redirect ไปยัง Patient Detail Page
```

#### UC-COMMUNITY-02: เรียกรถพยาบาล
```
1. เข้าสู่ Community Dashboard
2. คลิก "Request Ride"
3. เลือกผู้ป่วย: นาย ก. ข.
4. ข้อมูลผู้ป่วย Auto-fill:
   - ชื่อ: นาย ก. ข.
   - เบอร์โทร: 0812345678
   - สถานที่รับ: บ้านเลขที่ 123
5. กรอกปลายทาง: โรงพยาบาล
6. เลือกตำแหน่งปลายทางบนแผนที่
7. เลือกเวลานัดหมาย: วันนี้ 14:00 น.
8. เลือกประเภท: emergency
9. เลือกความต้องการพิเศษ: เปลนอน
10. กรอกหมายเหตุ: ผู้ป่วยติดเตียง
11. คลิก "Submit Request"
12. ระบบแสดงข้อความสำเร็จ
13. Redirect ไปยัง Manage Rides Page
14. เห็นคำขอใหม่ สถานะ: PENDING
```

#### UC-COMMUNITY-03: ติดตามสถานะการเดินทาง
```
1. เข้าสู่ Manage Rides Page
2. เห็นรายการการเดินทาง
3. คลิกดูรายละเอียดการเดินทาง
4. ดูสถานะ: ASSIGNED
5. ดูข้อมูลคนขับ:
   - ชื่อ: นาย ค.
   - เบอร์โทร: 0898765432
   - ทะเบียนรถ: กก 1234
6. รอจนสถานะเปลี่ยนเป็น IN_PROGRESS
7. ดูตำแหน่งคนขับบนแผนที่ (Real-time)
8. ติดตามจนสถานะเปลี่ยนเป็น COMPLETED
```

---

## 📊 EXECUTIVE - ผู้บริหาร

### สิทธิ์การเข้าถึง
- ✅ ดูรายงานและสถิติ (Read-only)
- ✅ วิเคราะห์ข้อมูล
- ✅ Export ข้อมูล
- ❌ ไม่สามารถแก้ไขข้อมูลได้

### หน้าจอหลัก

#### 1. ExecutiveDashboardPage.tsx

**ฟีเจอร์:**
```typescript
// Executive Dashboard
1. KPI Cards
   - จำนวนผู้ป่วยทั้งหมด
   - จำนวนการเดินทางทั้งหมด
   - จำนวนคนขับทั้งหมด
   - อัตราความสำเร็จ

2. กราฟและแผนภูมิ
   - กราฟแนวโน้มการเดินทาง (Line Chart)
   - กราฟสัดส่วนประเภทการเดินทาง (Pie Chart)
   - กราฟเปรียบเทียบคนขับ (Bar Chart)

3. สถิติ
   - เวลาเฉลี่ยต่อการเดินทาง
   - ระยะทางเฉลี่ย
   - อัตราการยกเลิก

4. รายงาน
   - รายงานรายวัน
   - รายงานรายสัปดาห์
   - รายงานรายเดือน

5. Export Data
   - Export เป็น PDF
   - Export เป็น Excel
   - Export เป็น CSV
```

**Components:**
- `ExecutiveDashboardWidgets.tsx` - Widgets สำหรับ Executive

### Use Cases

#### UC-EXECUTIVE-01: ดูรายงานประจำเดือน
```
1. เข้าสู่ Executive Dashboard
2. เลือกช่วงเวลา: เดือนนี้
3. ดู KPI:
   - จำนวนการเดินทาง: 150
   - อัตราความสำเร็จ: 95%
   - เวลาเฉลี่ย: 30 นาที
4. ดูกราฟแนวโน้ม
5. วิเคราะห์ข้อมูล
6. คลิก "Export to PDF"
7. ดาวน์โหลดรายงาน PDF
```

---

## 🔄 Data Flow Examples

### Example 1: การลงทะเบียนผู้ป่วย (End-to-End)

```
┌─────────────────────────────────────────────────────────────┐
│ COMMUNITY USER                                               │
├─────────────────────────────────────────────────────────────┤
│ 1. เข้าสู่ CommunityRegisterPatientPage.tsx                 │
│ 2. กรอกข้อมูล Wizard 5 ขั้นตอน                              │
│ 3. คลิก "Complete Registration"                             │
│ 4. handleWizardComplete(patientData)                        │
│ 5. patientsAPI.create(patientData)                          │
└──────────────────────┬──────────────────────────────────────┘
                       │ POST /api/patients
                       │ Headers: { Authorization: Bearer <token> }
                       │ Body: { ...patientData }
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ BACKEND (Express.js)                                         │
├─────────────────────────────────────────────────────────────┤
│ 1. Middleware Stack:                                         │
│    - authenticateToken() → Verify JWT                       │
│    - roleProtection(['community', 'OFFICER']) → Check role  │
│    - validatePatient() → Validate input (Joi)               │
│                                                              │
│ 2. Route Handler: routes/patients.ts                        │
│    - Generate patient ID: PAT-001                           │
│    - Hash sensitive data (if needed)                        │
│    - Add created_by: user.id                                │
│                                                              │
│ 3. Database Query:                                           │
│    - INSERT INTO patients (...) VALUES (...)                │
│                                                              │
│ 4. Audit Log:                                                │
│    - INSERT INTO audit_logs (action: CREATE_PATIENT)        │
│                                                              │
│ 5. Response:                                                 │
│    - { success: true, patient: { id, ...data } }            │
└──────────────────────┬──────────────────────────────────────┘
                       │ Response: 201 Created
                       │ Body: { success: true, patient: {...} }
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ FRONTEND (React)                                             │
├─────────────────────────────────────────────────────────────┤
│ 1. Receive response                                          │
│ 2. Show success toast notification                          │
│ 3. Navigate to PatientDetailPage                            │
│ 4. Display patient information                              │
└─────────────────────────────────────────────────────────────┘
```

### Example 2: การจ่ายงาน (Dispatch) พร้อม Real-time

```
┌─────────────────────────────────────────────────────────────┐
│ OFFICER                                                      │
├─────────────────────────────────────────────────────────────┤
│ 1. เข้าสู่ OfficeManageRidesPage.tsx                        │
│ 2. เห็นคำขอใหม่ (Socket.io: 'new_ride' event)              │
│ 3. คลิก "Assign Driver"                                     │
│ 4. เลือกคนขับที่ว่าง                                        │
│ 5. ยืนยันการมอบหมาย                                         │
│ 6. ridesAPI.updateRideStatus(rideId, 'ASSIGNED', driverId)  │
└──────────────────────┬──────────────────────────────────────┘
                       │ PUT /api/rides/:id
                       │ Body: { status: 'ASSIGNED', driver_id: 'DRV-001' }
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ BACKEND                                                      │
├─────────────────────────────────────────────────────────────┤
│ 1. Validate & Update database                               │
│ 2. UPDATE rides SET status='ASSIGNED', driver_id='DRV-001'  │
│ 3. INSERT INTO ride_events (event_type: 'ASSIGNED')         │
│ 4. Socket.io Emit:                                           │
│    - io.emit('ride_updated', rideData)                      │
│    - io.to(driverId).emit('new_job', rideData)              │
│ 5. Response: { success: true, ride: {...} }                 │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ├─────────────────────────────────────┐
                       │                                     │
                       ▼                                     ▼
┌──────────────────────────────┐  ┌──────────────────────────────┐
│ OFFICER (Real-time Update)   │  │ DRIVER (Real-time Update)    │
├──────────────────────────────┤  ├──────────────────────────────┤
│ 1. Socket: 'ride_updated'    │  │ 1. Socket: 'new_job'         │
│ 2. Update ride status in UI  │  │ 2. Show notification         │
│ 3. Show success message      │  │ 3. Add job to Today's Jobs   │
└──────────────────────────────┘  └──────────────────────────────┘
                                              │
                                              ▼
                                   ┌──────────────────────────────┐
                                   │ COMMUNITY (Real-time Update) │
                                   ├──────────────────────────────┤
                                   │ 1. Socket: 'ride_updated'    │
                                   │ 2. Update ride status        │
                                   │ 3. Show driver info          │
                                   └──────────────────────────────┘
```

### Example 3: GPS Tracking (Real-time)

```
┌─────────────────────────────────────────────────────────────┐
│ DRIVER (DriverLocationTracker Component)                    │
├─────────────────────────────────────────────────────────────┤
│ 1. navigator.geolocation.watchPosition()                    │
│ 2. ทุก 10 วินาที: Get current position                      │
│ 3. driversAPI.updateLocation(lat, lng)                      │
└──────────────────────┬──────────────────────────────────────┘
                       │ PUT /api/driver-locations
                       │ Body: { latitude: 13.7563, longitude: 100.5018 }
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ BACKEND                                                      │
├─────────────────────────────────────────────────────────────┤
│ 1. INSERT INTO driver_locations (...)                       │
│ 2. Socket.io Emit:                                           │
│    - io.emit('driver_location_update', {                    │
│        driver_id, latitude, longitude, timestamp            │
│      })                                                      │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│ OFFICER (MapCommandPage - Real-time Update)                 │
├─────────────────────────────────────────────────────────────┤
│ 1. Socket: 'driver_location_update'                         │
│ 2. Update driver marker on map                              │
│ 3. Animate marker movement                                  │
│ 4. Update driver info popup                                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 📝 สรุป

### ความแตกต่างหลักระหว่างบทบาท

| ฟีเจอร์ | DEVELOPER | ADMIN | OFFICER | DRIVER | COMMUNITY | EXECUTIVE |
|---------|-----------|-------|---------|--------|-----------|-----------|
| **ดูข้อมูลทั้งหมด** | ✅ | ✅ | ✅ | ❌ | ❌ | ✅ |
| **จัดการผู้ใช้** | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| **จัดการผู้ป่วย** | ✅ | ✅ | ✅ | ❌ | ✅* | ❌ |
| **จัดการการเดินทาง** | ✅ | ✅ | ✅ | ✅** | ✅* | ❌ |
| **จ่ายงาน** | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ |
| **ดู Audit Logs** | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| **ตั้งค่าระบบ** | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ |
| **ดูรายงาน** | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ |
| **แก้ไขข้อมูล** | ✅ | ✅ | ✅ | ✅*** | ✅* | ❌ |

**หมายเหตุ:**
- `*` = เห็นเฉพาะข้อมูลของตนเอง (Data Isolation)
- `**` = อัปเดตสถานะงานที่ได้รับมอบหมายเท่านั้น
- `***` = แก้ไขเฉพาะโปรไฟล์ตนเอง

---

## 🔗 เอกสารที่เกี่ยวข้อง

- **คู่มือ 1:** Overview & Architecture
- **คู่มือ 2:** Frontend Structure
- **คู่มือ 3:** Backend & Database

---

**จัดทำโดย:** AI Assistant  
**วันที่:** 29 มกราคม 2569  
**เวอร์ชัน:** 1.0
